name: CI - tag and release
on:
  push:
    branches:
    - main
    paths-ignore:
      - 'README.md'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
      - '.github/dependabot.yml'
      - '.github/FUNDING.yml'
      - '.github/SECURITY.md'
      - 'LICENSE.md'

jobs:
  update:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Bump version and push tag
      id: tag_version
      uses: mathieudutour/github-tag-action@v6.1
      with:
        github_token: ${{ secrets.TOKEN }}

    - name: Create a GitHub release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ steps.tag_version.outputs.new_tag }}
        name: Release ${{ steps.tag_version.outputs.new_tag }}
        body: ${{ steps.tag_version.outputs.changelog }}
        token: ${{ secrets.TOKEN }}

    - name: Release my project to homebrew
      run: |
        brew tap ${{ github.event.repository.owner.login }}/tap
        curl --version
        brew reinstall curl
        brew link curl --force
        echo 'export PATH="/usr/local/opt/curl/bin:$PATH"' >> /Users/runner/.bash_profile
        curl -V
        export HOMEBREW_FORCE_BREWED_CURL=true
        sha=$(curl -L https://github.com/Yarden-zamir/zsh-act-completion/archive/v0.0.12.tar.gz | shasum -a 256 | cut -d ' ' -f 1)
        echo $sha
        brew bump-formula-pr \
          --force \
          --url=https://github.com/Yarden-zamir/zsh-act-completion/archive/v0.0.12.tar.gz \
          --sha256=$sha \
          --message="Update zsh-act-completion to v0.0.12.    /auto-merge" \
          zsh-act-completion
      env:
        HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.TOKEN }}
